#!/usr/bin/python
#remember: open up a new file stream every time
import os, sys, time, socket, thread
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
fp = open(sys.argv[2], 'r+')
fp.seek(0,0)
try:
	sys.argv[3]
except IndexError:
	bedtime = 5
else:
	bedtime = int(sys.argv[3])
if sys.argv[1] == '-l':
	pwd = raw_input("Please enter your desired password: ");
	s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
	s.bind(('', 5068))
	s.listen(5)
	c, caddr = s.accept()
	cpass = c.recv(16)
	if cpass != pwd:
		c.send("errpass")
		c.close(); s.close()
		exit()
	else: c.send("OK")
	try:
		while True:
			fp.seek(0,0)
			fc = c.recv(1073741824)
			fp.truncate()
			fp.seek(0,0)
			fp.write(fc)
			fp.seek(0,0)
			time.sleep(bedtime)
			fp = open(sys.argv[2], 'r+')
			fp.seek(0,0)
			fim = fp.read()
			c.send(fim)
	except:
		print fc
		c.close()
		s.close()
		fp.truncate()
		fp.seek(0,0)
		fp.write(fc)
		exit()
else:
	pwd = raw_input("Password: ")
	s.connect((socket.gethostbyname(sys.argv[1]), 5068))
	s.send(pwd)
	if s.recv(8) == 'errpass':
		s.close()
		print "Error: incorrect password."
		exit()
	try:
		while True:
			fp = open(sys.argv[2], 'r+')
			fp.seek(0,0)
			s.send(fp.read())
			fp.seek(0,0)
			fc = s.recv(1073741824)
			fp.truncate()
			fp.seek(0,0)
			fp.write(fc)
			fp.seek(0,0)
			time.sleep(bedtime)
	except:
		s.close()
		fp.truncate()
		fp.seek(0,0)
		fp.write(fc)
		print fc
		exit()
