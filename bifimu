#!/usr/bin/python
import os, sys, time, socket
cfc = 0
header = '\1\1\2\5'
fp_arr = []     #file pointer array
fn_arr = sys.argv[3:]   #file name array
fc_arr = []     #file contents array
BEDTIME = int(sys.argv[2])
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
for i in fn_arr: fp_arr.append(open(i, 'r+'))
if sys.argv[1] == '-l':
	s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
	s.bind(('', 5068))
	s.listen(5)
	c, caddr = s.accept()
	pwd = raw_input("Please enter your desired password: ");
	if cpass != pwd:
		c.send("err")
		c.close(); s.close()
		exit()
	else: c.send("ack")
	try:
		while True:
			cfc = 0
			for fp in fp_arr:
				fc = c.recv(2147483647/2)
				fl = fc.split(header)[-2]
				fp.truncate()
				if cfc > len(fc_arr) - 1: fc_arr.append(fl)
				else: fc_arr[cfc] = fl
				fp.write(fl)
				fp.seek(0,0)
				cfc = cfc + 1
			time.sleep(BEDTIME)
			try: c.send('ack')
			except socket.error:
				for fp in fp_arr:
					fp.close()
				c.close()
				s.close()
				exit()
			c.recv(3)
			cfc = 0
			for fp in fp_arr:
				fp = open(fn_arr[cfc], 'r+')
				c.send(fp.read() + header)
				fp.seek(0,0)
				cfc = cfc + 1
	except KeyboardInterrupt:
		c.send('die')
		for fp in fp_arr:
			fp.close()
		c.close()
		s.close()
		exit()
else:
	pwd = raw_input('Password: ')
	s.connect((socket.gethostbyname(sys.argv[1]), 5068))
	s.send(pwd)
	if s.recv(3) == 'err':
		s.close()
		print "Error: incorrect password."
		exit()
	try:
		while True:
			cfc = 0
			for fp in fp_arr:
				fp = open(fn_arr[cfc], 'r+')
				s.send(fp.read() + header)
				fp.seek(0,0)
				cfc = cfc + 1
			time.sleep(BEDTIME)
			if s.recv(3) == 'die':
				for fp in fp_arr:
					fp.close()
				s.close()
				exit()
			s.send('ack')
			cfc = 0
			for fp in fp_arr:
				fc = s.recv(2147483647/2)
				fp.truncate()
				if cfc > len(fc_arr) - 1: fc_arr.append(fl)
				else: fc_arr[cfc] = fl
				fp.write(fl)
				fp.seek(0,0)
				cfc = cfc + 1
	except KeyboardInterrupt:
		for fp in fp_arr:
			fp.close()
		s.close()
		exit()
